// Generated by CoffeeScript 1.6.2
(function() {
  'RequireJS provides Asynchronous Module Definition loading, but we first must configure a few of our libraries to work with it. This includes Handlebars because it does not support AMD natively. The `shim` argument configures \nRequireJS to wrap scripts so that other modules can use them as injected, modular dependencies.\n\nFor `Video.js` and `ResponseSlives.js`, specify that they depend upon `jQuery`.';  requirejs.config({
    shim: {
      handlebars: {
        exports: 'Handlebars'
      },
      video: ['jquery'],
      'responsiveslides.min': ['jquery'],
      'bootstrap.min': ['jquery']
    }
  });

  'Now, we configure this `main` module by specifing which modules it needs to operate by calling the \n`require` function and passing in an array of modules to inject. \n\nNotice that we only declare three formal arguments because those are the only ones we actually need to \nreference in our initialization function, but since event handler and other UI code requires the other \nlibraries, we ensure that they get loaded now before initialization.';

  require(['handlebars', 'jquery', 'moment', 'video', 'responsiveslides.min', 'jquery.mobile', 'bootstrap.min'], function(Handlebars, $, moment) {
    'When all the modules are injected, we will use jQuery\'s AJAX support through `$.get` to fetch the \ndata from our Windows Azure hosted REST service. Internally, the web service pulls the data out of MongoDB, \nwhich is itself hosted via MongoLabs.\n\nBut, we do need to declare and initialize our functions first.';
    'The most important function is `bindCatalogEntry`. It takes care of formating the catalog entry and \npopulating / configuring the templated items with data, delegating most of the work to Handlebars templates, \nand calling a few jQuery Mobile functions to enhance the HTML controls in their JQM-ified selves.';
    var appName, bindCatalogEntry, getQueryStringParam, initializeMediaSlider, resizeVideoJS, runTemplate, videoControl;

    bindCatalogEntry = function(entry) {
      var visualLinks;

      runTemplate('#appCatalogEntryTmpl', '#appCatalogEntry', entry);
      $('.updates').collapsible();
      $('.download').button();
      $('.textLinks').listview();
      $('.qualityBand').popup();
      visualLinks = {
        visualLinks: entry.visualLinks
      };
      return runTemplate('#visualLinksTmpl', '.visualLinks', visualLinks);
    };
    initializeMediaSlider = function() {
      return $('.rslides').responsiveSlides({
        auto: false,
        pager: true,
        nav: true,
        speed: 500,
        maxwidth: 800,
        navContainer: '#navContainer',
        namespace: 'centered-btns',
        before: function() {
          return videoControl(function(video) {
            return video.pause();
          });
        }
      });
    };
    'This utility function makes calling Handlebars templates easier.';
    runTemplate = function(source, target, data) {
      var html, template;

      source = $(source).html();
      template = Handlebars.compile(source);
      html = template(data);
      return $(target).html(html);
    };
    'Register some formatting helpers for Handlebars to handle dates and the custom video tag content from our schema.';
    Handlebars.registerHelper('dateFormat', function(context, block) {
      var f;

      if (window.moment) {
        f = block.hash.format || 'MMM DD, YYYY';
        return moment(context).format(f);
      } else {
        return context;
      }
    });
    Handlebars.registerHelper('renderContent', function(content) {
      return new Handlebars.SafeString(content);
    });
    'The `videoControl` function uses jQuery to match all elements with a class of `video-js` \nso that we can pause and resize all instances of videos on the screen at once when navigating \nwith the `ResponseSlives.js` plugin.';
    videoControl = function(callback) {
      return $('.video-js').each(function() {
        var id, video;

        id = $(this).attr('id');
        'The crazy `_V_` function comes from the Video.js library, and it requires an id attribute \non elements to match.';
        video = _V_(id);
        return callback(video);
      });
    };
    'And, this provides responsive support for resizing the videos or images when the browser window size changes.';
    resizeVideoJS = function() {
      var aspectRatio;

      aspectRatio = 504 / 640;
      return videoControl(function(video) {
        var width;

        width = document.getElementById(video.id).parentElement.offsetWidth;
        return video.width(width).height(width * aspectRatio);
      });
    };
    'Lets us grab a query string parameter from the URL.';
    getQueryStringParam = function(variable) {
      var i, pair, query, vars;

      query = window.location.search.substring(1);
      vars = query.split('&');
      i = 0;
      while (i < vars.length) {
        pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) === variable) {
          return decodeURIComponent(pair[1]);
        }
        i++;
      }
      return console.log("Query variable %s not found", variable);
    };
    'Load the app now:';
    window.onresize = resizeVideoJS;
    resizeVideoJS();
    appName = getQueryStringParam('app');
    if (appName == null) {
      return;
    }
    return $.get('http://appcatalog.azurewebsites.net/appcatalog/entries?staticId=' + appName).done(function(data) {
      bindCatalogEntry(data);
      resizeVideoJS();
      $('#appCatalogEntryList').remove();
      return initializeMediaSlider();
    });
  });

}).call(this);
